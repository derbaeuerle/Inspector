/*! PROJECT_NAME - v0.1.0 - 2013-07-18
* http://PROJECT_WEBSITE/
* Copyright (c) 2013 YOUR_NAME; Licensed MIT */
inspector={intents:{init:"inspector://init/"},connections:{},commandAddress:"http://localhost:9090/inspector/",stateAddress:"http://localhost:9191/state/",max_timeouts:10,state_stream:null,__id:null,init:function(){inspector.__id=inspector.__generateUID(),inspector.intents.init+=inspector.__id+"/",inspector.sendIntent(inspector.intents.init);var a=document.createEvent("Event");a.initEvent("inspector-ready",!0,!0),window.dispatchEvent(a)},sendIntent:function(a){iframe=document.createElement("iframe"),iframe.id="ajaxFrame",iframe.style.display="none",iframe.src=a,document.body.appendChild(iframe),window.setTimeout(function(){document.body.removeChild(iframe)},10)},use:function(a,b){return Object.keys(inspector.connections).length||inspector.state_stream?!Object.keys(inspector.connections).length&&inspector.state_stream&&(console.log(inspector.state_stream.isRunning()),inspector.state_stream.isRunning()||(inspector.state_stream.timeouts=0,inspector.state_stream.getState())):(inspector.state_stream=new inspector.stateStream,inspector.state_stream.getState()),a=a.toUpperCase(),a in inspector.connections||(inspector.connections[a]=new inspector.gadget(a,b)),inspector.connections[a]},__generateCallbackName:function(){return"cb"+inspector.__generateUID()},__generateUID:function(){return parseInt(1e3*((new Date).getTime()/Math.random()),10)},stateStream:function(){var a=this;a.timeouts=0,a.callbackName="inspector_state",a.running=!0,a.script=null,a.isRunning=function(){return a.running},a.getState=function(){console.log("getState()"),a.callbackName="inspector_state_"+inspector.__generateCallbackName(),window[a.callbackName]=b,url=inspector.stateAddress+"?id="+inspector.__id+"&callback="+a.callbackName,a.script=document.createElement("script"),a.script.src=url,a.script.onerror=function(){a.timeouts+=1,a.script.parentNode.removeChild(a.script),a.timeouts<inspector.max_timeouts&&a.running&&(inspector.sendIntent(inspector.intents.init),window.setTimeout(function(){a.getState()},500*a.timeouts))},document.body.appendChild(a.script)},a.stop=function(){a.running=!1};var b=function(b){try{for(id in b){item=b[id];var c=inspector.connections[item.gadget];if(c&&c.eventListener[item.event]){var d=c.eventListener[item.event];for(i in d){var e=d[i];alarm=!0,itemData=item.data;for(con in e.conditions)if(!(con in itemData)||itemData[con]!=e.conditions[con]){alarm=!1;break}alarm&&e.callback(item)}}}}catch(f){console.log("error")}delete window[a.callbackName],a.script.parentNode.removeChild(a.script),a.script=null,a.running&&a.getState()}},gadget:function(a,b){var c=this;c.gadget=a,c.callbackName=inspector.__generateCallbackName(),c.eventListener={},c.script=null,c.basicUrl=inspector.commandAddress+a+"/",c.timeouts=0,c.keep_alive=b||200,c.__destroyed=!1,c.on=function(a,b,d){return a in c.eventListener||(c.eventListener[a]=[]),c.eventListener[a].push({id:c.eventListener[a].length,callback:b,conditions:d}),c.eventListener[a].length-1},c.off=function(a,b){return element=c.eventListener[a].findAttribute("id",b),!!c.eventListener[a].splice(element,1)},c.submit=function(a,b){c.__destroyed||d(a,b)},c.__destroy=function(){try{delete window[c.callbackName],c.callbackName=null}catch(a){}try{c.script.parentNode.removeChild(c.script),c.script=null}catch(a){}delete inspector.connections[c.gadget],0===Object.keys(inspector.connections).length&&inspector.state_stream.stop(),c.__destroyed=!0},c.__errorHandler=function(a){if(2===a){var b=confirm("Permission request: "+c.gadget);b?(params={permission:b},d(params,function(){c.script.parentNode.removeChild(c.script),delete window[c.callbackName],e()})):error&&error({error:{message:"Permission denied by user!",code:-1}})}};var d=function(a,b){var f=inspector.__generateCallbackName();url=c.basicUrl+"?callback="+f;for(key in a)a.hasOwnProperty(key)&&(url+="&"+key+"="+a[key]);script=document.createElement("script"),script.src=url,script.onerror=function(){c.timeouts+=1,script.parentNode.removeChild(c.script),c.timeouts<inspector.max_timeouts&&window.setTimeout(function(){d(a,b)},50*c.timeouts)},window[f]=function(a){try{b(a)}finally{script.parentNode.removeChild(script),delete window[f],e()}},document.body.appendChild(script)},e=function(){url=c.basicUrl+"keep-alive/?callback="+c.callbackName,c.script=document.createElement("script"),c.script.src=url,c.script.onerror=function(){c.timeouts+=1,c.script.parentNode.removeChild(c.script),c.timeouts<inspector.max_timeouts&&window.setTimeout(function(){e()},50*c.timeouts)},c.callbackName&&(window[c.callbackName]=f,document.body.appendChild(c.script))},f=function(){try{window.setTimeout(function(){e()},c.keep_alive)}catch(a){}finally{c.script.parentNode.removeChild(c.script)}};e()}},window.addEventListener("load",inspector.init);