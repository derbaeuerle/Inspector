/*! PROJECT_NAME - v0.1.0 - 2013-07-16
* http://PROJECT_WEBSITE/
* Copyright (c) 2013 YOUR_NAME; Licensed MIT */
function addLoadEvent(a){var b=window.onload;window.onload="function"!=typeof window.onload?a:function(){b&&b(),a()}}function replaceTag(a){return tagsToReplace[a]||a}function safe_tags_replace(a){return a.replace(/[&<>]/g,replaceTag)}inspector={initCommand:"inspector://init/",destroyCommand:"inspector://destroy/",serverAddress:"http://localhost:9090/inspector/",gadgets:{AUDIO:"AUDIO",ACCELERATION:"ACCELERATION",GYROSCOPE:"GYROSCOPE",TEMPERATURE:"TEMPERATURE",LIGHT:"LIGHT",MAGNETIC:"MAGNETIC",ORIENTATION:"ORIENTATION",PRESSURE:"PRESSURE",PROXIMITY:"PROXIMITY"},listeners:{},timeout:-1,init:function(){inspector.initInspector();var a=document.createEvent("Event");a.initEvent("inspector-ready",!0,!0),window.dispatchEvent(a),window.addEventListener("blur",function(){html=document.documentElement,classes=html.className,html.className=classes.replace("focused","blured"),console.log(html.className)}),window.addEventListener("focus",function(){html=document.documentElement,classes=html.className,html.className=classes.replace("blured","focused"),console.log(html.className)})},initInspector:function(){inspector.sendIntent(inspector.initCommand)},destroyInspector:function(){inspector.destroyListeners(),inspector.sendIntent(inspector.destroyCommand)},destroyListeners:function(){for(var a in inspector.listeners)inspector.unlisten(a)},sendIntent:function(a){iframe=document.createElement("iframe"),iframe.id="ajaxFrame",iframe.style.display="none",iframe.onerror=function(a){document.body.removeChild(iframe),console.log(a)},iframe.onload=function(){document.body.removeChild(iframe)},inspector.browser?(window.onbeforeunload=function(){window.location="#",window.stop()},window.location=a):iframe.src=a,document.body.appendChild(iframe)},listen:function(gadget,opts,callback,error,delay){do streamId="inspector"+parseInt(1e3*((new Date).getTime()/Math.random()),10),opts.streamid=streamId;while(opts.streamid in inspector.listeners);return inspector.listeners[opts.streamid]={streamid:opts.streamid,gadget:gadget,opts:opts,callback:callback,error:error,delay:delay||500},clazz=function(){this.id=opts.streamid,this.gadget=gadget,this.opts=opts,this.delay=delay||500},con=new inspector.connection(opts.streamid,gadget,opts,delay),error?eval("con.error = "+error.toString()):con.error=function(){},eval("con.callback = "+callback.toString()),con},connection:function(a,b,c,d){this.id=a,this.gadget=b,this.opts=c,this.delay=d,this.call=function(){var a=this;console.log("delay: "+this.delay),url=inspector.serverAddress+this.gadget+"/";do var b="ins"+parseInt(1e3*((new Date).getTime()/Math.random()),10);while(inspector[b]);a.cbName=b,url+="?callback=inspector."+b;for(key in this.opts)this.opts.hasOwnProperty(key)&&(url+="&"+key+"="+this.opts[key]);a.sc=document.createElement("script"),this.error&&(a.sc.onerror=this.error);var c=this.callback||function(){};inspector[b]=function(b){try{if(b.error)if(b.error.errorCode){var d=b.error.errorCode;2==d&&window.setTimeout(function(){inspector.requestPermission(a.gadget,a.opts,c,a.error)},100)}else a.error&&a.error(response);else"stream"in response&&response.stream.streamid==a.id?(c(response),window.setTimeout(function(){a.call()},a.delay)):window.setTimeout(function(){c(response)},100)}finally{delete inspector[a.cbName],script.parentNode.removeChild(a.script)}},a.sc.src=url,document.body.appendChild(a.sc)},this.destroy=function(){}},unlisten:function(a){a in inspector.listeners&&delete inspector.listeners[a]},call:function(a,b,c,d,e){url=inspector.serverAddress+a+"/";do var f="inspector"+parseInt(1e3*((new Date).getTime()/Math.random()),10);while(inspector[f]);url+="?callback=inspector."+f;for(var g in b)b.hasOwnProperty(g)&&(url+="&"+g+"="+b[g]);script=document.createElement("script"),script.onerror=function(f){d&&d(f,a,b,c,d),e&&e>0&&(inspector.initInspector(),window.setTimeout(function(){e-=1,inspector.call(a,b,c,d,e)},1500))},inspector[f]=function(g){try{if(g.error)if(g.error.errorCode){var h=g.error.errorCode;2==h&&window.setTimeout(function(){inspector.requestPermission(a,b,c,d,e)},100)}else d&&d(g);else"stream"in g&&g.stream.streamid in inspector.listeners?(stream=inspector.listeners[g.stream.streamid],stream.callback(g),window.setTimeout(function(){inspector.call(stream.gadget,stream.opts,stream.callback,stream.error)},stream.delay)):window.setTimeout(function(){c(g)},100)}finally{delete inspector[f],script.parentNode.removeChild(script)}},script.src=url,document.body.appendChild(script)},requestPermission:function(a,b,c,d,e){var f=confirm("Permission request: "+a);f?(b.permission=f,window.setTimeout(function(){inspector.call(a,b,c,d,e)},100)):d&&d({error:{message:"Permission denied by user!",code:-1}})},logger:function(a){console.log(a)}},addLoadEvent(inspector.init),inspector.audio={template:'<span class="state">unknown</span><span class="play" inspector-action="play" onclick="inspector.audio.onClick(this);" href="#">Play</span>&nbsp;<span class="pause" inspector-action="pause" onclick="inspector.audio.onClick(this);" href="#">Pause</span>&nbsp;<span class="stop" inspector-action="stop" onclick="inspector.audio.onClick(this);" href="#">Stop</span>&nbsp;',instances:{},elements:{},force:!0,onClick:function(b){for(action=b.getAttribute("inspector-action"),file=b.parentNode.getAttribute("src"),playerid=b.parentNode.id,-1===file.indexOf("http")&&(loc=window.location.href.replace(location.hash,"").replace("#",""),file=loc.indexOf("/",loc.length-1)?loc+file:loc+"/"+file),file=encodeURIComponent(file),opts={audiofile:file,"do":action,playerid:playerid},a=0;a<b.parentNode.attributes.length;a++)attr=b.parentNode.attributes[a],attr.value===!0||""===attr.value?attr.value=!0:attr.value||(attr.value=!1),opts[attr.name.replace("inspector-","")]=attr.value;inspector.call(inspector.gadgets.AUDIO,opts,function(a){a.playerid&&(playerid=a.playerid,b=inspector.audio.elements[playerid]);var c=document.createEvent("Event");c.initEvent("state",!0,!0),c.detail=a,c.request={message:action,audiofile:file,playerid:playerid,response:a},b.dispatchEvent(c),b.update(a),"play"===action&&(inspector.audio.instances[playerid]=inspector.listen(inspector.gadgets.AUDIO,{"do":"state",playerid:playerid},function(a){a.playerid&&(playerid=a.playerid,b=inspector.audio.elements[playerid]);var c=document.createEvent("Event");c.initEvent("state",!0,!0),c.detail=a,b.dispatchEvent(c),b.update(a),inspector.audio.checkState(a)},null,200)),inspector.audio.checkState(a)},null,20)},checkState:function(a){if(!a||1==a.stopped||"PAUSED"==a.state||"STOPPED"==a.state)if(stream=a.stream,"playerid"in a&&a.playerid)inspector.audio.instances[a.playerid]==stream.streamid&&(inspector.unlisten(stream.streamid),delete inspector.audio.instances[key]);else for(key in inspector.audio.instances)inspector.audio.instances[key]==stream.streamid&&(inspector.unlisten(stream.streamid),delete inspector.audio.instances[key])},needReplacement:function(a){for(srcs=a.getElementsByTagName("source"),x=0;x<srcs.length;x++)if(a.canPlayType(srcs[x].getAttribute("type")))return!1;return!0},check:function(){var a=document.getElementsByTagName("audio");for(i=0;i<a.length;i++)if(audio=a[i],inspector.audio.force||inspector.audio.needReplacement(audio)){for(id=parseInt((new Date).getTime()/Math.random(),10),id="iaudio"+id,iaudio=document.createElement("inspector-audio"),iaudio.id=id,iaudio.setAttribute("inspector-playerid",id),iaudio.setAttribute("src",audio.getElementsByTagName("source")[0].getAttribute("src")),iaudio.innerHTML=inspector.audio.template,o=0;o<audio.attributes.length;o++)iaudio.setAttribute(audio.attributes[o].name,audio.attributes[o].value);iaudio.play=function(){el=this.getElementsByClassName("play")[0],el&&el.click()},iaudio.stop=function(){el=this.getElementsByClassName("stop")[0],el&&el.click()},iaudio.stop=function(){el=this.getElementsByClassName("pause")[0],el&&el.click()},iaudio.update=function(a){el=this.getElementsByClassName("state")[0],el&&(el.innerHTML=a.state||"unknown")},iaudio.seek=function(a){inspector.call(inspector.gadgets.AUDIO,{audiofile:iaudio.getAttribute("src"),"do":"seek",playerid:iaudio.getAttribute("inspector-playerid"),seekto:a},function(a){var b=document.createEvent("Event");b.initEvent("state",!0,!0),b.detail=a,iaudio.dispatchEvent(b),inspector.audio.updateState(iaudio,a)})},iaudio.volume=function(a){inspector.call(inspector.gadgets.AUDIO,{audiofile:iaudio.getAttribute("src"),"do":"volume",playerid:iaudio.getAttribute("inspector-playerid"),volume:a},function(a){var b=document.createEvent("Event");b.initEvent("state",!0,!0),b.detail=a,iaudio.dispatchEvent(b),inspector.audio.updateState(iaudio,a)})},iaudio.leftVolume=function(a){inspector.call(inspector.gadgets.AUDIO,{audiofile:iaudio.getAttribute("src"),"do":"volume",playerid:iaudio.getAttribute("inspector-playerid"),"volume-left":a},function(a){var b=document.createEvent("Event");b.initEvent("state",!0,!0),b.detail=a,iaudio.dispatchEvent(b),inspector.audio.updateState(iaudio,a)})},iaudio.rightVolume=function(a){inspector.call(inspector.gadgets.AUDIO,{audiofile:iaudio.getAttribute("src"),"do":"volume",playerid:iaudio.getAttribute("inspector-playerid"),"volume-right":a},function(a){var b=document.createEvent("Event");b.initEvent("state",!0,!0),b.detail=a,iaudio.dispatchEvent(b),inspector.audio.updateState(iaudio,a)})},audio.parentNode.replaceChild(iaudio,audio),inspector.audio.elements[id]=iaudio,i--,inspector.audio.autoplay(iaudio)}},autoplay:function(a){(a.getAttribute("autoplay")||""===a.getAttribute("autoplay"))&&a.play()},init:function(){inspector.audio.check();var a=document.createEvent("Event");a.initEvent("inspector-audio-ready",!0,!0),window.dispatchEvent(a)}},addLoadEvent(inspector.audio.init);var tagsToReplace={"&":"&amp;","<":"&lt;",">":"&gt;"};