/*! PROJECT_NAME - v0.1.0 - 2013-06-27
* http://PROJECT_WEBSITE/
* Copyright (c) 2013 YOUR_NAME; Licensed MIT */
function addLoadEvent(a){var b=window.onload;window.onload="function"!=typeof window.onload?a:function(){b&&b(),a()}}function getElementByAttribute(a,b,c){if(c=c||document.body,c.hasAttribute(a)&&c.getAttribute(a)==b)return c;for(var d,e=c.children,f=e.length;f--;)if(d=getElementByAttribute(a,b,e[f]))return d;return null}inspector={initCommand:"inspector://init/",destroyCommand:"inspector://destroy/",serverAddress:"http://localhost:9090/inspector/",gadgets:{AUDIO:"AUDIO",ACCELERATION:"ACCELERATION",GYROSCOPE:"GYROSCOPE",TEMPERATURE:"TEMPERATURE",LIGHT:"LIGHT",MAGNETIC:"MAGNETIC",ORIENTATION:"ORIENTATION",PRESSURE:"PRESSURE",PROXIMITY:"PROXIMITY"},listeners:{},browser:null,timeout:-1,init:function(){inspector.logger("init inspector"),inspector.initInspector();var a=document.createEvent("Event");a.initEvent("inspector-ready",!0,!0),window.dispatchEvent(a)},initInspector:function(){inspector.sendIntent(inspector.initCommand)},destroyInspector:function(){inspector.destroyListeners(),inspector.sendIntent(inspector.destroyCommand)},destroyListeners:function(){for(var a in inspector.listeners){var b=inspector.listeners[a];for(var c in b)inspector.unlisten(a,c)}},sendIntent:function(a){iframe=document.createElement("iframe"),iframe.id="ajaxFrame",iframe.style.display="none",iframe.onerror=function(a){document.body.removeChild(iframe),console.log(a)},inspector.browser?(window.onbeforeunload=function(){window.location="#",window.stop()},window.location=a):iframe.src=a,document.body.appendChild(iframe)},listen:function(a,b,c){return a in inspector.listeners||(inspector.listeners[a]=[]),id=window.setInterval(function(){inspector.call(a,b,c)},500),inspector.listeners[a][id]=id,id},unlisten:function(a,b){a in inspector.listeners&&b in inspector.listeners[a]&&(gadgetListeners=inspector.listeners[a],window.clearInterval(gadgetListeners[b]),delete gadgetListeners[gadgetListeners.indexOf(b)])},call:function(a,b,c){url=inspector.serverAddress+a+"/";var d="inspector"+Math.floor((new Date).getTime()/Math.random());url+="?callback=inspector."+d;for(var e in b)b.hasOwnProperty(e)&&(url+="&"+e+"="+b[e]);script=document.createElement("script"),script.onerror=inspector.onError,this[d]=function(a){try{c(a)}finally{delete this[d],script.parentNode.removeChild(script)}},script.src=url,document.body.appendChild(script)},onError:function(a){if(-1===inspector.timeout)inspector.timeout=20,inspector.timeout--,inspector.initInspector();else if(inspector.timeout>0)inspector.initInspector(),inspector.timeout--;else if(0===inspector.timeout)throw new Exception("Failed to establish connection!");console.error(a)},logger:function(a){console.log(a)}},addLoadEvent(inspector.init),inspector.audio={id:1,template:'<inspector-audio-state>unknown</inspector-audio-state><button inspector-action="play" onclick="inspector.audio.onClick(this);">Play</button><button inspector-action="pause" onclick="inspector.audio.onClick(this);">Pause</button><button inspector-action="stop" onclick="inspector.audio.onClick(this);">Stop</button>',instances:{},elements:[],onClick:function(a){action=a.getAttribute("inspector-action"),file=a.parentNode.getAttribute("src"),playerid=a.parentNode.getAttribute("inspector-playerid"),-1===file.indexOf("http")&&(loc=window.location.href,file=loc.indexOf("/",loc.length-1)?loc+file:loc+"/"+file),file=encodeURIComponent(file),inspector.call(inspector.gadgets.AUDIO,{audiofile:file,"do":action,playerid:playerid},function(b){var c=document.createEvent("Event");c.initEvent("state",!0,!0),c.detail=b,c.request={message:action,audiofile:file,playerid:playerid,response:b},a.parentNode.dispatchEvent(c),inspector.audio.updateState(a.parentNode,b)}),"play"===action?inspector.audio.instances[playerid]=inspector.listen(inspector.gadgets.AUDIO,{"do":"state",playerid:playerid},function(b){var c=document.createEvent("Event");c.initEvent("state",!0,!0),c.detail=b,a.parentNode.dispatchEvent(c),inspector.audio.updateState(a.parentNode,b)}):window.setTimeout(function(){inspector.unlisten(inspector.gadgets.AUDIO,inspector.audio.instances[playerid])},500)},updateState:function(a,b){sEl=a.getElementsByTagName("inspector-audio-state"),sEl.length>0&&(sEl=sEl[0],sEl.innerHTML=b.state||"unknown")},needReplacement:function(a){for(srcs=a.getElementsByTagName("source"),x=0;x<srcs.length;x++)if(a.canPlayType(srcs[x].getAttribute("type")))return!1;return!0},check:function(){var a=document.getElementsByTagName("audio");for(i=0;i<a.length;i++)if(inspector.audio.needReplacement(a[i])){id=(new Date).getTime()/inspector.audio.id++,id/=Math.floor(1001*Math.random()),id="iaudio"+id;var b=document.createElement("inspector-audio");b.setAttribute("inspector-playerid",id),b.setAttribute("src",a[i].getElementsByTagName("source")[0].getAttribute("src")),b.innerHTML=inspector.audio.template,b.play=function(){el=getElementByAttribute("inspector-action","play",b),el&&el.click()},b.stop=function(){el=getElementByAttribute("inspector-action","stop",b),el&&el.click()},b.stop=function(){el=getElementByAttribute("inspector-action","pause",b),el&&el.click()},a[i].parentNode.replaceChild(b,a[i]),inspector.audio.elements.push(b),i--}},init:function(){inspector.logger("init() audio"),inspector.audio.check();var a=document.createEvent("Event");a.initEvent("inspector-audio-ready",!0,!0),window.dispatchEvent(a)}},addLoadEvent(inspector.audio.init);